<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Archive for hobby information</title>
		<style>
			body {
				margin: 0px;
				background-color: #eeeeee;
			}

			.section {
				font-size: 20px;
				margin: 20px;
				padding: 20px;
				text-transform: uppercase;
			}
			.container {
				display: inline-flex;
				flex-wrap: wrap;
				width: calc(100% - 16px);
				padding: 7px;
			}

			.child {
				aspect-ratio: 1 / 1;
				margin:7px;
				text-align: center;
				font-size: 30px;
				padding: 20px;
				cursor: pointer;
			}

			.child-image {
				padding: 0px;
				overflow: hidden;
				border-radius: 15px;
			}

			.centered {
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100%;
			}

			@media screen and (max-width: 610px) {
				.child {
					width: calc(100% - 54px);
				}
				.child-image {
					width: calc(100% - 14px);
				}
			}

			@media screen and (min-width: 611px) and (max-width: 1010px) {
				.child {
					width: calc(50% - 54px);
				}
				.child-image {
					width: calc(50% - 14px);
				}
			}

			@media screen and (min-width: 1011px) and (max-width: 1500px) {
				.child {
					width: calc(33.3% - 54px);
				}
				.child-image {
					width: calc(33.3% - 14px);
				}
			}

			@media screen and (min-width: 1501px) {
				.child {
					width: calc(25% - 54px);
				}
				.child-image {
					width: calc(25% - 14px);
				}
			}

			.background-odd {
				background: radial-gradient(65% 50% at center , #d5d5d5 30%, #eeeeee 75%);
			}

			.background-even {
				background: radial-gradient(65% 50% at center , #dfdfdf 30%, #eeeeee 75%);
			}

			/* FIX OF UGLY SELECT */
			select, .multiselect {
				background: url("data:image/svg+xml,<svg height='10px' width='10px' viewBox='0 0 16 16' fill='%23000000' xmlns='http://www.w3.org/2000/svg'><path d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/></svg>") no-repeat;
				background-position: calc(100% - 0.75rem) center !important;
				-moz-appearance:none !important;
				-webkit-appearance: none !important; 
				appearance: none !important;
				padding-right: 2rem !important;
				border-radius: 8px;
				border-color: lightslategray;
				border-width: 1px;
				box-shadow: none;
			}

			.slide {
				width: 100%;
				transition: all 0.5s;
				flex-shrink: 0;
				display: flex;
				justify-content: center;
				align-items: center; 
			}

			.child img {
				width: 100%;
				border-radius: 15px;
			}

			.hidden {
				display: none;
			}

			.grey {
				color: grey;
			}

			button, select, .multiselect {
				font-family: Arial;
			}

			.multiselect {
				border-color: lightslategray !important;
				border-radius: 10px;
				border: solid 1px;
				position: relative;
				width: 170px;
				user-select: none;
			}

			#multipleCheckbox {
				position: absolute;
				left: 0;
				right: 0;
				top: 55px;
				display: none;
				border: 1px solid;
				border-color: lightslategray !important;
				border-radius: 10px;
				padding-top: 10px;
				background-color: #e5e5e5;
				max-height: 300px;
				overflow-y: auto;
			}

			.tagOption {
				height: 35px;
				float: left;
				clear: left;
			}
			.tagOption label {
				overflow: hidden;
				width: 165px;
				display: inline-block;
				text-align: left;
			}
			.tagOption input {
				float: left;
				margin-top: 5px;
				margin-right: 7px;
				margin-left: 12px;
			}
		</style>
		<script type="text/javascript" src="data.js"></script>
		<script>
			const byId = (query) => {
				return document.querySelector(query);
			};

			const main = () => {
				const types = [];
				const tagData = {
					index: {},
					tags: []
				};

				data.entities.forEach((item) => {
					const type = item.editable.type;

					if (types.indexOf(type) === -1) {
						types.push(type);
					}

					const tags = item.editable.data.tags || [];

					tags.forEach((tag) => {
						if (tagData.index[tag] === undefined) {
							tagData.index[tag] = [];
						}

						const index = tagData.index[tag];

						if (index.indexOf(item.id) === -1) {
							index.push(item.id);
						}

						if (tagData.tags.indexOf(tag) === -1) {
							tagData.tags.push(tag);
						}
					});
				});

				const multipleCheckbox = byId("#multipleCheckbox");
				tagData.tags.forEach((tag) => {
					const count = tagData.index[tag].length;

					const tagOption = document.createElement("div");
					tagOption.className = "tagOption";
					const input = document.createElement("input");
					input.type = "checkbox";
					input.id = tag;
					tagOption.appendChild(input);
					const label = document.createElement("label");
					label.htmlFor = tag;
					label.innerHTML = tag + " <span class=\"grey\">(" + count + ")</span>";
					tagOption.appendChild(label);

					
					multipleCheckbox.appendChild(tagOption);
				});

				const typesDiv = byId("#types");
				types.forEach((type) => {
					const button = document.createElement("button");
					button.id = type;
					button.innerHTML = type;
					button.className = "section";
					typesDiv.appendChild(button);
				});

				const container = byId("#container");
				data.entities.forEach((entity, index) => {
					const id = entity.id;
					const name = entity.editable.name;

					const item = document.createElement("div");
					item.id = entity.id;
					const backgroundClass = index % 2 === 0 ? "background-even" : "background-odd"; 
					item.classList.add("child", "centered", backgroundClass);
					if (entity.editable.type === "image") {
						const img = document.createElement("img");
						img.src = "images/" + entity.editable.data.src;
						item.appendChild(img);
						item.classList.add("child-image");
					}
					else {
						item.innerHTML = name;
					}
					container.appendChild(item);
					item.addEventListener("click", () => {location.href='entity.html?id=' + id;});
				});

				const hideTagOptions = () => {
					byId("#multipleCheckbox").style.display = "none";
				};

				byId("#tags").addEventListener("click", () => {
					const checkboxes = byId("#multipleCheckbox");

					if (checkboxes.style.display === "block") {
						hideTagOptions();
					} else {
						checkboxes.style.display = "block";
					}
				});

				const state = {
					tagsCheckedStatus: {}
				}

				const rerenderVisibleEntities = () => {
					const chosenTags = [];

					checked = state.tagsCheckedStatus;

					Object.keys(checked).forEach((tag) => {
						if (checked[tag] === true) {
							chosenTags.push(tag);
						}
					});

					if (chosenTags.length === 0) {
						container.childNodes.forEach((node, index) => {
							const classList = node.classList; 
							classList.remove("hidden", "background-even", "background-odd");

							const backgroundClass = index % 2 === 0 ? "background-even" : "background-odd";
							classList.add(backgroundClass);
						});
					} else {
						let chosenIds = tagData.index[chosenTags[0]];
						chosenTags.forEach((chosenTag) => {
							const relatedIds = tagData.index[chosenTag];
							console.log(chosenTag);
							chosenIds = relatedIds.filter((relatedId) => {
								return chosenIds.includes(relatedId);
							});
						});
						let filteredCounter = 0;

						container.childNodes.forEach((node) => {
							const nodeId = parseInt(node.id);

							if (chosenIds.indexOf(nodeId) === -1) {
								node.classList.add("hidden");
							} else {
								const classList = node.classList; 
								classList.remove("hidden", "background-even", "background-odd");

								const backgroundClass = filteredCounter % 2 === 0 ? "background-even" : "background-odd";
								classList.add(backgroundClass);

								filteredCounter++;
							}
						});
					}
				}

				byId("#multipleCheckbox").addEventListener("click", (e) => {
					e.stopPropagation();

					const tagName = e.target.id;

					if (tagName !== "") {
						state.tagsCheckedStatus[tagName] = !state.tagsCheckedStatus[tagName];

						rerenderVisibleEntities();
					}
				});
				document.addEventListener("click", (e) => {
					const id = e.target.id;

					if (id !== "multipleCheckbox" && id !== "tags" && id !== "tagsOptionsLabel") {
						hideTagOptions();
					}
				});
				byId("#sort").addEventListener("focus", () => {
					hideTagOptions();
				});
				byId("#sort").addEventListener("change", (e) => {
					console.log(e.target.value);
				});
			};

			window.addEventListener("load", main);
		</script>
	</head>
	<body>
		<div id="types" style="text-align: center;">
		</div>
		<div style="text-align: center; width: calc(100% - 16px); margin: 10px;margin-bottom: 20px;">
			<div class="multiselect" style="font-size: 20px; margin: 10px; padding: 15px; display: inline-block;" id="tags">
					<div style="text-align: left;" id="tagsOptionsLabel">
						Filter by tags
					</div>
					<div id="multipleCheckbox">
					</div>
			</div>
			<select style="font-size: 20px; margin: 10px; padding: 15px; display: inline-block; vertical-align: top;" id="sort">
				<option value="idAsc">By Id Ascending</option>
				<option value="idDesc">By Id Descending</option>
				<option value="nameAsc">By Name Ascending</option>
				<option value="nameDesc">By Name Descending</option>
			</select>
		</div>
		<div class="container" id="container"></div>
	</body>
</html>